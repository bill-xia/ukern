# ukern

这是一个简单的微内核操作系统。目前打算将其运行在Intel 64体系结构上。制作这个操作系统的初衷是自己设计这个内核，掌握设计系统的能力和C语言项目的各种工具的使用方法。我希望这个操作系统有如下特性：

1. 源码可读性高，达到工业界项目的代码规范要求
2. 有良好的文档和易于理解的系统概念模型，便于自学
3. 尽可能地拥有高性能和简单的机制，如果一些不显然必需的功能会显著降低性能，性能优先，抛弃这一功能
4. “正确地”使用cmake, make, ld等工具
5. 有良好甚至“优秀”的设计，例如：允许用户使用2^64B的整个地址空间

它最终应当实现以下功能：

1. 实现用户态和内核态
2. 实现POSIX中最重要的系统调用，包括其所需的syscall和用户级库
3. 较完整地实现一个文件系统（如FAT32）
4. 实现IPC
5. 实现shell与一些常用的用户程序（如cd, ls, chown等）
6. 可以运行一些不需要标准库的OI代码！（需要有浮点数支持）
7. 细粒度的内核锁，不留下显然的低性能代码
8. 可以测量系统的性能

如下为进阶功能，视实现难度与意义再决定是否实现：

1. 操作系统内部的编辑器，甚至编译器！这样就可以在这个系统上工作了
2. 网络驱动
3. 图形界面（不写显卡驱动应该大概率刷新率小于1Hz，所以写一个不拉跨的界面应该有相当难度）
4. 多体系结构支持

## Usage

### 环境配置

```
sudo apt install gcc build-essential qemu ovmf # to be tested and completed
cp /usr/share/OVMF/OVMF_VARS.fd ./
make qemu
```

OVMF_VARS 是 UEFI 的配置记录文件，我们在 UEFI 中进行的配置更改（如添加启动项）都会存储在这个文件中。由于不同的仓库中 OVMF_VARS 不完全相同，它没有被 git 管理，所以需要在配环境时手动拷贝到当前文件夹。这个文件不要轻易删除，否则 UEFI 的配置更改旧都失效了。

然后连按 Esc 进入 UEFI 菜单，添加一个启动选项 BOOTX64.EFI。

注意不要轻易删除 diskimg，否则重新生成的 diskimg 会有不同的 PARTUUID，UEFI 配置的启动项就失效了。如果误删了也不要紧，重新配置一次启动项就好。

### 日常调试

```
make qemu
```

## 注意事项

配环境很重要，心态要放好，认真学习这些工具是目的之一。写的每一行（配置）代码心里都要清楚，勤搜索勤研究。累了就歇歇放下改天再做，也不要混过去。

### 常用命令

#### gdb

- si/stepi 单步执行

##### Remote 'g' packet reply is too long (expected 308 bytes, got 536 bytes)

```
disconnect
set arch i386:x86-64
target remote localhost:1234
```